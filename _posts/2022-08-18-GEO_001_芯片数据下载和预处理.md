---
layout:     post
title:      GEO芯片数据分析
date:       2022-08-18
author:     Iris
tags:
    - 生信
    - GEO芯片数据
---

# 001_数据下载和探针转换

## 1.设置环境

```r
getwd() # 确认所在路径
setwd() # 修改路径
rm(list = ls())  # 一键清空已有变量
options(stringsAsFactors = F)# 在调用as.data.frame的时，将stringsAsFactors设置为FALSE可以避免character类型自动转化为factor类型
```

## 2.下载数据

```r
library(GEOquery)

gset <- getGEO('GSE42872', 
               destdir=".",
               AnnotGPL = F,     ## 注释文件
               getGPL = F)       ## 平台文件

gset # 查看数据信息
```

![gset信息](/gset.png)

```r
dat <- exprs(gset[[1]]) # 获取表达矩阵

dat[1:5,1:5] # 查看表达矩阵，前5行，前5列
```

![dat前5行，前5列](https://github.com/iriswang1995/iriswang1995.github.io/blob/master/图片/GEO_001_图片/dat.png)

## 3.获取临床数据

```r
pd <- pData(gset[[1]])
# 挑选感兴趣的临床数据
library(stringr)
group_list <- str_split(pd$title,' ',simplify = T)[,4]
table(group_list)
```

![分组信息](https://github.com/iriswang1995/iriswang1995.github.io/blob/master/图片/GEO_001_图片/分组.png)

## 4.获取平台数据

```r
# 下载平台数据，也可以去GEO网页手动下载
gpl <- getGEO('GPL6244', destdir=".")
head(Table(gpl)[2,c(1,10)]) # 查看GPL第2行的1和10列，发现gene symb藏在gene_assignment中间，被"//"隔开
```

![查看平台信息第2行的1、10列](https://github.com/iriswang1995/iriswang1995.github.io/blob/master/图片/GEO_001_图片/查看GPL.png)

```r
probe2gene=Table(gpl)[,c(1,10)] # 取出GPL的1和10列，现在需要将gene symbol取出来

library(dplyr)
library(tidyr) 
probe2gene <- probe2gene %>%
  # 用separate()函数分割gene_assignment，只给了两个列名，即只留下前两列
  separate(gene_assignment, into = c("drop", "symbol"), sep = "//") %>%
  # 删除drop
  select(-drop) %>%
  # 删除symbol为空的行
  filter(symbol != "")

head(probe2gene) # 查看probe2gene
save(probe2gene,file='probe2gene.Rdata') # 保存数据
```

![查看probe2gene](https://github.com/iriswang1995/iriswang1995.github.io/blob/master/图片/GEO_001_图片/probe2gene.png)

## 5.转换表达矩阵的探针名

```r
probe2gene$ID <- as.character(probe2gene$ID) # 将probe2gene$ID转换为字符串，不然可能会报错

library(tibble)
dat <- dat %>%
  # 将dat的行名变成列，注意要与probe2gene的探针列名相同
  rownames_to_column("ID") %>% 
  # 合并dat和probe2gene
  inner_join(probe2gene) %>%
  # 删除ID
  dplyr::select(-ID) %>%
  # 将symbol提到第一列
  dplyr::select(symbol,everything()) %>%
  # 由于symb可能有重复，所以需要去重，这里选择表达量最高的一个
  # 生成新的一列，数值是每行的平均值
  mutate(rowMean = rowMeans(.[,-1])) %>%
  # 按照rowMean从大到小的顺序重新排序
  arrange(desc(rowMean)) %>%
  # 当遇到重复的symbol时，选择第一个
  distinct(symbol, .keep_all = T) %>%
  # 删除rowMean
  dplyr::select(-rowMean) %>%
  # symbol转为行名
  column_to_rownames("symbol")

head(dat) # 查看dat

save(dat,group_list,file = 'step1-output.Rdata') # 保存数据
```

![最终结果](https://github.com/iriswang1995/iriswang1995.github.io/blob/master/图片/GEO_001_图片/最终结果.png)
**最后生成行名是gene symbol，列名是样本的数据框**
